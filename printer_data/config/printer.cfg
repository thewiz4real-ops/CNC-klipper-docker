[include savevars_only.cfg]
# ===== MCU =====
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1XXXXXXXXXXXXXXXXXXX-if00
baud: 115200
restart_method: command

# ===== Machine =====
[printer]
kinematics: cartesian
#max_velocity: 200          # CNC: be conservative; raise after testing
#max_accel: 2000
#square_corner_velocity: 8
#max_z_velocity: 50
#max_z_accel: 400
max_velocity: 40             # 40 mm/s = 2400 mm/min rapids (adjust later)
max_accel: 300
#max_accel_to_decel: 300
square_corner_velocity: 1.0  # smooth starts/stops
# Z can be much slower so it doesn't slam
max_z_velocity: 10            # 8 mm/s = 480 mm/min
max_z_accel: 120

# Enable G2/G3 arcs from CAM
[gcode_arcs]
resolution: 0.1

[homing_override]
axes: xyz
gcode:
  {% set all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
  {% set doX = all or 'X' in params %}
  {% set doY = all or 'Y' in params %}
  {% set doZ = all or 'Z' in params %}

  M400
  # Keep Z energized and increase hold so it resists sag
  SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
  SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.90 HOLDCURRENT=0.50

  # Home Z (this calls Klipper's built-in homing from inside the override)
  {% if doZ %}
    G28 Z
 {% endif %}

  # Then home X/Y as requested
  {% if doX and doY %}
    G28 X Y
  {% elif doX %}
    G28 X
  {% elif doY %}
    G28 Y
  {% endif %}

#################################################################
#                        STEPPERS (KK60)                        #
# KK60-10 = 10 mm lead  -> rotation_distance: 10.0 mm/rev
# If your axis is 5 mm lead, set rotation_distance: 5.0
#################################################################

# ---- X axis (KK60-10, ~600 mm) ----
[stepper_x]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
microsteps: 16
rotation_distance: 10.0        # <= 10 mm lead (change to 5.0 if needed)
endstop_pin: ^!PC0             # your photo endstop on X
position_endstop: 0
position_max: 514              # adjust to your usable travel
homing_speed: 50

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin:  PC10
uart_address: 0
run_current: 0.90
hold_current: 0.30
stealthchop_threshold: 0

# ---- Y axis (KK60-10, ~500 mm) ----
[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 10.0
endstop_pin: ^!PC1
position_endstop: 0
position_max: 410
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin:  PC10
uart_address: 1
run_current: 0.90
hold_current: 0.30
stealthchop_threshold: 0

# ---- Z axis (KK60-10, ~200 mm) ----
[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
microsteps: 16
rotation_distance: 10.0
endstop_pin: ^!PC2            # keep a Z endstop if you have one
position_endstop: 115
position_max: 115             # adjust to your usable travel
homing_speed: 10
homing_positive_dir: true

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin:  PC10
uart_address: 2
run_current: 0.90
hold_current: 0.30
stealthchop_threshold: 0

#################################################################
#                        PROBE (Touch Plate)                    #
#################################################################

# Use the BLTouch/PROBE header signal = PC14 (top pin on the 5-pin probe header)
# Wire: plate -> PC14, tool clip -> GND on that same header.
[probe]
pin: ^!PC14
x_offset: 0
y_offset: 0
z_offset: 0

[respond]
# (optional) default prefix: prefix: cnc

# Store variables to disk (optional but recommended)
;[save_variables]
;filename: /opt/printer_data/config/variables.cfg

;[include savevars_only.cfg]

# --- Touch-plate macros with persistence and messages ---

[gcode_macro SET_PLATE_THICKNESS]
variable_plate_thickness: 10.00
gcode:
  {% set t = params.T|default(printer["gcode_macro SET_PLATE_THICKNESS"].plate_thickness)|float %}
  SET_GCODE_VARIABLE MACRO=SET_PLATE_THICKNESS VARIABLE=plate_thickness VALUE={t}
  RESPOND MSG="Touch-plate thickness = {t} mm"
;  SAVE_VARIABLES

[gcode_macro PROBE_Z_TOUCHPLATE]
# Usage: PROBE_Z_TOUCHPLATE [LIFT=5] [F=120]
gcode:
  {% set lift = params.LIFT|default(5)|float %}
  {% set feed = params.F|default(120)|float %}
  {% set t = 19.5 %}                     # <-- hard-coded plate thickness

  # Clear any old Z offset so we start clean
  SET_GCODE_OFFSET Z=0 MOVE=0

  # Safety: probe shouldn't already read TRIGGERED
  QUERY_PROBE
  {% if printer.probe.last_query == "TRIGGERED" %}
    RESPOND PREFIX="error" MSG="Probe already TRIGGERED (clip touching plate?)."
    CANCEL_PRINT
  {% endif %}

  # Compute a small approach move down, without crossing Z min
  {% set zmax = printer.toolhead.axis_maximum.z|float %}
  {% set zmin = printer.toolhead.axis_minimum.z|float %}
  {% set zcur = printer.toolhead.position.z|float %}
  {% set pre = lift if (zcur - zmin) >= lift else (zcur - zmin) %}

  SAVE_GCODE_STATE NAME=__pz
  G91
  G1 Z-{pre} F600
  G90

  # Probe down to the plate
  PROBE SPEED={feed}

  # Restore modes/feeds (but not position move)
  RESTORE_GCODE_STATE NAME=__pz MOVE=0

  # *** Set Z0 based on hard-coded plate thickness ***
  G92 Z{t}

  # Retract up, capped by Z max
  {% set zcur2 = printer.toolhead.position.z|float %}
  {% set up = lift if (zmax - zcur2) >= lift else (zmax - zcur2) %}
  G91
  G1 Z{up} F600
  G90

  RESPOND PREFIX="info" MSG="Z set using touch-plate (t={t} mm)"

#[gcode_macro SHOW_PLATE_THICKNESS]
#gcode:
#  RESPOND MSG="Touch-plate thickness = {printer['gcode_macro SET_PLATE_THICKNESS'].plate_thickness} mm"

[gcode_macro SHOW_PLATE_THICKNESS]
gcode:
  RESPOND MSG="Touch-plate thickness = 19.5 mm (hard-coded)"

#################################################################
#                          FANS (optional)                      #
#################################################################

[fan]
pin: PA4

[fan_generic controller_fan]
pin: PA7
max_power: 1.0
shutdown_speed: 0

#################################################################
#                (Intentionally removed / not used)             #
# - All extruder/heater/bed sections (CNC mode)
# - Any duplicate [extruder] blocks from the PnP config
#################################################################

# --- Let Mainsail upload/run files ---
[virtual_sdcard]
path: /opt/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# --- Mainsail status integration ---
[display_status]

# --- Enable PAUSE/RESUME/CANCEL base hooks ---
[pause_resume]

# --- CNC-friendly PAUSE/RESUME/CANCEL (no extruder stuff) ---
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
variable_park_x: 0        # where to park X when paused
variable_park_y: 0        # where to park Y when paused
variable_park_z: 10.0     # how much to lift before parking
gcode:
  SAVE_GCODE_STATE NAME=PAUSE_state
  BASE_PAUSE
  {% set zx = printer["gcode_macro PAUSE"].park_z|float %}
  {% set px = printer["gcode_macro PAUSE"].park_x|float %}
  {% set py = printer["gcode_macro PAUSE"].park_y|float %}
  G91
  G1 Z{zx} F1500          ; lift up
  G90
  G0 X{px} Y{py} F6000    ; move to park

[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
  G90
  RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
  BASE_RESUME

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
  M5                      ; stop spindle if youâ€™ve mapped M3/M5
  G90
  G0 Z10 F1500            ; lift to a safe height
  BASE_CANCEL_PRINT  